<%# Manage Guests Content - Unified layout for host and invitee %>
<%# Host sees the same layout as invitee, but with controls to change guest status %>

<%# Compute participation counts %>
<% all_participations = event.participations.includes(:user).order("users.name ASC") %>
<% going_participations = all_participations.where(status: "going") %>
<% maybe_participations = all_participations.where(status: "maybe") %>
<% not_going_participations = all_participations.where(status: ["not_going", "declined"]) %>

<%# Count participations (people who RSVP'd) %>
<% going_participation_count = going_participations.count %>
<% maybe_participation_count = maybe_participations.count %>
<% not_going_participation_count = not_going_participations.count %>

<%# Calculate totals including extra guests %>
<% going_extra_guests = going_participations.sum(:extra_guests) %>
<% maybe_extra_guests = maybe_participations.sum(:extra_guests) %>
<% going_count = going_participation_count + going_extra_guests %>
<% maybe_count = maybe_participation_count + maybe_extra_guests %>

<%# Check if current user is the host %>
<% is_host = user_signed_in? && event.user == current_user %>

<%# Helper to compute initials %>
<%
  def content_initials(user)
    if user.name.present?
      parts = user.name.strip.split
      parts.length >= 2 ? "#{parts.first[0]}#{parts.last[0]}".upcase : parts.first[0..1].upcase
    else
      user.email.split("@").first[0..1].upcase
    end
  end
%>

<%= turbo_frame_tag "manage-guests-content" do %>
  <%# Unified header %>
  <h2 class="manage-guests-title"><%= is_host ? "Manage Guests" : "Who's Going" %></h2>

  <%# Summary counts (no emojis) %>
  <div class="guests-modal-summary">
    <span class="summary-item summary-going"><%= going_count %> going</span>
    <% if maybe_count > 0 %>
      <span class="summary-item summary-maybe"><%= maybe_count %> maybe</span>
    <% end %>
    <% if is_host && not_going_participation_count > 0 %>
      <span class="summary-item summary-not-going"><%= not_going_participation_count %> not going</span>
    <% end %>
  </div>

  <%# Going section %>
  <% if going_participation_count > 0 %>
    <ul class="manage-guests-list<%= ' guests-readonly' unless is_host %>">
      <% going_participations.each do |participation| %>
        <%= render "events/manage_guests_row", event: event, participation: participation, is_host: is_host %>
      <% end %>
    </ul>
  <% else %>
    <p class="guests-modal-empty">No one has confirmed yet.</p>
  <% end %>

  <%# Maybe section %>
  <% if maybe_participation_count > 0 %>
    <h3 class="guests-modal-subheading">Maybe attending</h3>
    <ul class="manage-guests-list<%= ' guests-readonly' unless is_host %>">
      <% maybe_participations.each do |participation| %>
        <%= render "events/manage_guests_row", event: event, participation: participation, is_host: is_host %>
      <% end %>
    </ul>
  <% end %>

  <%# Not going section (host only) %>
  <% if is_host && not_going_participation_count > 0 %>
    <h3 class="guests-modal-subheading">Not going</h3>
    <ul class="manage-guests-list">
      <% not_going_participations.each do |participation| %>
        <%= render "events/manage_guests_row", event: event, participation: participation, is_host: is_host %>
      <% end %>
    </ul>
  <% end %>
<% end %>
