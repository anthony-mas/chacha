<%# Manage Guests Modal - Host sees management view, invitees see read-only view %>

<%# Compute participation counts using same logic as _guests_list %>
<% all_participations = event.participations.includes(:user).order("users.name ASC") %>
<% going_participations = all_participations.where(status: "going") %>
<% maybe_participations = all_participations.where(status: "maybe") %>
<% not_going_participations = all_participations.where(status: ["not_going", "declined"]) %>

<% going_count = going_participations.count %>
<% maybe_count = maybe_participations.count %>
<% not_going_count = not_going_participations.count %>

<%# Check if current user is the host %>
<% is_host = user_signed_in? && event.user == current_user %>

<%# Helper to compute initials (same as _guests_list) %>
<%
  def modal_initials(user)
    if user.name.present?
      parts = user.name.strip.split
      parts.length >= 2 ? "#{parts.first[0]}#{parts.last[0]}".upcase : parts.first[0..1].upcase
    else
      user.email.split("@").first[0..1].upcase
    end
  end
%>

<div class="rsvp-modal-overlay manage-guests-overlay is-hidden" id="manage-guests-modal">
  <div class="rsvp-modal manage-guests-modal">
    <button type="button" class="rsvp-modal-close manage-guests-close" aria-label="Close">&times;</button>

    <% if is_host %>
      <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
      <%# HOST VIEW: Full management controls %>
      <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
      <h2 class="manage-guests-title">Manage Guests</h2>

      <div class="manage-guests-tools">
        <div class="manage-guests-search">
          <input type="search" placeholder="Find a guest..." class="rsvp-input">
        </div>

        <div class="manage-guests-filter">
          <select class="rsvp-input status-filter-select">
            <option value="all">All Statuses</option>
            <option value="going">Going</option>
            <option value="maybe">Maybe</option>
            <option value="not_going">Not going</option>
          </select>
        </div>

        <div class="manage-guests-status-tabs">
          <button type="button" class="status-tab active" data-status="going">
            <span class="status-emoji">üëç</span>
            <span class="status-label">Going</span>
            <span class="status-count"><%= going_count %></span>
          </button>
          <button type="button" class="status-tab" data-status="maybe">
            <span class="status-emoji">ü§î</span>
            <span class="status-label">Maybe</span>
            <span class="status-count"><%= maybe_count %></span>
          </button>
          <button type="button" class="status-tab" data-status="not_going">
            <span class="status-emoji">üëé</span>
            <span class="status-label">Not going</span>
            <span class="status-count"><%= not_going_count %></span>
          </button>
        </div>
      </div>

      <ul class="manage-guests-list">
        <% all_participations.each do |participation| %>
          <li class="manage-guests-item" data-status="<%= participation.status %>">
            <div class="guest-info">
              <div class="guest-avatar" style="background-color: #<%= Digest::MD5.hexdigest(participation.user.email)[0..5] %>;">
                <%= modal_initials(participation.user) %>
              </div>
              <div class="guest-details">
                <span class="guest-name"><%= participation.user.name.presence || participation.user.email.split("@").first %></span>
                <% if participation.extra_guests.to_i > 0 %>
                  <small class="extra-guests-badge">+<%= participation.extra_guests %></small>
                <% end %>
              </div>
            </div>

            <select class="guest-status-select">
              <option value="going" <%= 'selected' if participation.status == 'going' %>>üëç Going</option>
              <option value="maybe" <%= 'selected' if participation.status == 'maybe' %>>ü§î Maybe</option>
              <option value="not_going" <%= 'selected' if participation.status == 'not_going' || participation.status == 'declined' %>>üëé Not going</option>
            </select>
          </li>
        <% end %>
      </ul>

    <% else %>
      <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
      <%# INVITEE VIEW: Read-only guest list %>
      <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
      <h2 class="manage-guests-title">Who's Going</h2>

      <%# Summary counts %>
      <div class="guests-modal-summary">
        <span class="summary-item summary-going">üëç <%= going_count %> going</span>
        <% if maybe_count > 0 %>
          <span class="summary-item summary-maybe">ü§î <%= maybe_count %> maybe</span>
        <% end %>
      </div>

      <% if going_count > 0 %>
        <ul class="manage-guests-list guests-readonly">
          <% going_participations.each do |participation| %>
            <li class="manage-guests-item">
              <div class="guest-info">
                <div class="guest-avatar" style="background-color: #<%= Digest::MD5.hexdigest(participation.user.email)[0..5] %>;">
                  <%= modal_initials(participation.user) %>
                </div>
                <div class="guest-details">
                  <span class="guest-name"><%= participation.user.name.presence || participation.user.email.split("@").first %></span>
                  <% if participation.extra_guests.to_i > 0 %>
                    <small class="extra-guests-badge">+<%= participation.extra_guests %></small>
                  <% end %>
                </div>
              </div>
              <span class="guest-status-badge status-going">Going</span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="guests-modal-empty">No one has confirmed yet.</p>
      <% end %>

      <% if maybe_count > 0 %>
        <h3 class="guests-modal-subheading">Maybe attending</h3>
        <ul class="manage-guests-list guests-readonly">
          <% maybe_participations.each do |participation| %>
            <li class="manage-guests-item">
              <div class="guest-info">
                <div class="guest-avatar" style="background-color: #<%= Digest::MD5.hexdigest(participation.user.email)[0..5] %>;">
                  <%= modal_initials(participation.user) %>
                </div>
                <div class="guest-details">
                  <span class="guest-name"><%= participation.user.name.presence || participation.user.email.split("@").first %></span>
                </div>
              </div>
              <span class="guest-status-badge status-maybe">Maybe</span>
            </li>
          <% end %>
        </ul>
      <% end %>
    <% end %>
  </div>
</div>
