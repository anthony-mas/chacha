<%# Event Guest List Preview with Avatars, Count, Mutuals, and View All button %>

<%# Filter to only "going" participations for attendance display %>
<% going_participations = event.participations.includes(:user).where(status: "going") %>
<% going_count = going_participations.count %>
<% extra_guests_total = going_participations.sum(:extra_guests) %>
<% total_attending = going_count + extra_guests_total %>

<%# Check if current user is going %>
<% current_user_going = user_signed_in? && going_participations.exists?(user_id: current_user.id) %>
<% others_going_count = current_user_going ? going_count - 1 : 0 %>

<%# Avatar display: show first 5, then +X for remainder %>
<% max_avatars = 5 %>
<% displayed_participations = going_participations.order("users.name ASC").limit(max_avatars) %>
<% overflow_count = going_count > max_avatars ? going_count - max_avatars : 0 %>


<%= turbo_frame_tag "guests-list" do %>
<div class="guests-list-container">
  <div class="guests-header">
    <h2 class="title-md"><strong>Guest List</strong></h2>
    <button type="button" class="btn-view-all manage-guests-trigger">View all</button>
  </div>

  <%# Attendance count %>
  <div class="guests-attendance-info">
    <% if total_attending > 0 %>
      <p class="guests-total-count">
        <i class="fa-solid fa-users"></i>
        <%= total_attending %> <%= total_attending == 1 ? "person is" : "people are" %> going
      </p>

      <%# Mutual text for logged-in user who is going %>
      <% if current_user_going %>
        <p class="guests-mutual-text">
          <% if others_going_count > 0 %>
            You and <%= others_going_count %> <%= others_going_count == 1 ? "other" : "others" %> are going
          <% else %>
            You're the only one going so far
          <% end %>
        </p>
      <% end %>
    <% else %>
      <p class="guests-empty-text">No one has RSVP'd yet. Be the first!</p>
    <% end %>
  </div>

  <%# Avatar row %>
  <% if going_count > 0 %>
    <div class="guests-avatars-row">
      <% displayed_participations.each do |participation| %>
        <div class="guests-avatar-bubble" style="background-color: <%= avatar_color_for(participation.user) %>;" title="<%= participation.user.name.presence || participation.user.email %>">
          <%= avatar_initials_for(participation.user) %>
        </div>
      <% end %>

      <% if overflow_count > 0 %>
        <div class="guests-avatar-bubble guests-avatar-overflow">
          +<%= overflow_count %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
<% end %>
