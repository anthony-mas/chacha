<div class="event-page">

  <div class="event-card-detail">

    <div class="event-hero-wrapper">
      <% if @event.hero_image.attached? %>
        <%= image_tag @event.hero_image, class: "event-hero-image" %>
      <% else %>
        <div class="event-hero-placeholder">
          <span class="placeholder-icon">ğŸ–¼ï¸</span>
        </div>
      <% end %>
    </div>

    <div class="event-content-wrapper">

      <header class="event-header">
        <h1 class="centered-title"><%= @event.title.presence ||
"Event" %></h1>

        <div class="event-metadata">
          <p>
            ğŸ—“ï¸ <%= @event.starts_on.strftime("%A %d %B, %H:%M") %>
            <% if @event.ends_on.present? %>
              â€“ <%= @event.ends_on.strftime("%A %d %B, %H:%M") %>
            <% end %>
          </p>
          <p>
            ğŸ“ <%= @event.location %>
          </p>
          <p>
            ğŸ”’ <%= @event.event_private ? "Yes" : "No" %>
          </p>
        </div>
      </header>

      <section class="event-description">
        <br>
        <p><%= @event.description.presence ||
      "No description yet." %></p>
      </section>

      <% if user_signed_in? && @event.user == current_user %>
        <section class="event-host-tools">
          <p>
            <%= link_to "Edit event", edit_event_path(@event) %> |
<%= link_to "Delete", @event, data: { turbo_method: :delete, turbo_confirm: "Are you sure?"
} %>
          </p>

          <div class="host-actions-buttons">
            <button type="button" class="btn btn-action-large btn-send-blast" disabled>
              <i class="fa-solid fa-bullhorn"></i>
              Send a blast
            </button>
            <button type="button" class="btn btn-action-large btn-invite-guests share-modal-trigger">
              <i class="fa-solid fa-share-from-square"></i>
              Invite Guests
            </button>
          </div>
        </section>
      <% end %>

      <section class="event-rsvp">
        <h2>Attending?</h2>
        <% current_participation = user_signed_in? ? @event.participations.find_by(user: current_user) : nil %>
        <% current_status = current_participation&.status %>
        <div class="rsvp-segmented-control">
          <button type="button" class="rsvp-segment <%= 'active' if current_status == 'going' %>" data-rsvp-status="going">
            <span class="rsvp-segment-label">Going</span>
          </button>
          <button type="button" class="rsvp-segment <%= 'active' if current_status == 'maybe' %>" data-rsvp-status="maybe">
            <span class="rsvp-segment-label">Maybe</span>
          </button>
          <button type="button" class="rsvp-segment <%= 'active' if current_status == 'not_going' %>" data-rsvp-status="not_going">
            <span class="rsvp-segment-label">Not Going</span>
          </button>
        </div>
      </section>

      <%= render "rsvp_modal" %>

      <section class="event-main-layout">
        <div class="event-guests-panel">
          <%= render "guests_list", event: @event %>
        </div>

        <div class="event-activity-panel">
          <%= render "events/activity", event: @event %>
        </div>
      </section>

      <p>
        <%= link_to "Back to my events", events_path %>
      </p>

    </div>
  </div>
</div>

<%= render "events/share_modal" %>
<%= render "events/manage_guests_modal", event: @event %>

<script>
(function() {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RSVP Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rsvpOverlay = document.querySelector('.rsvp-modal-overlay:not(.manage-guests-overlay)');
  const rsvpCloseBtn = rsvpOverlay ? rsvpOverlay.querySelector('.rsvp-modal-close') : null;
  const rsvpSegments = document.querySelectorAll('.rsvp-segment');
  const rsvpModalEmojis = rsvpOverlay ? rsvpOverlay.querySelectorAll('.rsvp-emoji-choice') : [];

  function openRsvpModal(status) {
    if (!rsvpOverlay) return;
    rsvpOverlay.classList.remove('is-hidden');
    document.body.style.overflow = 'hidden';
    rsvpModalEmojis.forEach(btn => {
      btn.classList.toggle('selected', btn.dataset.rsvpStatus === status);
    });
  }

  function closeRsvpModal() {
    if (!rsvpOverlay) return;
    rsvpOverlay.classList.add('is-hidden');
    document.body.style.overflow = '';
  }

  function setActiveSegment(status) {
    rsvpSegments.forEach(seg => {
      seg.classList.toggle('active', seg.dataset.rsvpStatus === status);
    });
  }

  rsvpSegments.forEach(btn => {
    btn.addEventListener('click', () => {
      setActiveSegment(btn.dataset.rsvpStatus);
      openRsvpModal(btn.dataset.rsvpStatus);
    });
  });

  if (rsvpCloseBtn) {
    rsvpCloseBtn.addEventListener('click', closeRsvpModal);
  }

  if (rsvpOverlay) {
    rsvpOverlay.addEventListener('click', (e) => {
      if (e.target === rsvpOverlay) closeRsvpModal();
    });
  }

  rsvpModalEmojis.forEach(btn => {
    btn.addEventListener('click', () => {
      rsvpModalEmojis.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      setActiveSegment(btn.dataset.rsvpStatus);
    });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Manage Guests Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const guestsOverlay = document.querySelector('.manage-guests-overlay');
  const guestsCloseBtn = guestsOverlay ? guestsOverlay.querySelector('.manage-guests-close') : null;
  const guestsTriggers = document.querySelectorAll('.manage-guests-trigger');
  const statusTabs = guestsOverlay ? guestsOverlay.querySelectorAll('.status-tab') : [];

  function openGuestsModal() {
    if (!guestsOverlay) return;
    guestsOverlay.classList.remove('is-hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeGuestsModal() {
    if (!guestsOverlay) return;
    guestsOverlay.classList.add('is-hidden');
    document.body.style.overflow = '';
  }

  guestsTriggers.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openGuestsModal();
    });
  });

  if (guestsCloseBtn) {
    guestsCloseBtn.addEventListener('click', closeGuestsModal);
  }

  if (guestsOverlay) {
    guestsOverlay.addEventListener('click', (e) => {
      if (e.target === guestsOverlay) closeGuestsModal();
    });
  }

  // Status tab selection (visual only for now)
  statusTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      statusTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Share Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const shareBackdrop = document.querySelector('.share-modal-backdrop');
  const shareContent = shareBackdrop ? shareBackdrop.querySelector('.share-modal-content') : null;
  const shareCloseBtn = shareBackdrop ? shareBackdrop.querySelector('.share-modal-close-btn') : null;
  const shareTriggers = document.querySelectorAll('.share-modal-trigger');
  const shareCopyBtns = document.querySelectorAll('.share-copy-btn, .share-link-copy-btn');
  const shareNativeBtn = document.querySelector('.share-native-btn');
  const shareCopiedFeedback = document.getElementById('share-copied-feedback');

  function openShareModal() {
    if (!shareBackdrop) return;
    shareBackdrop.classList.add('share-modal-active');
    document.body.style.overflow = 'hidden';
  }

  function closeShareModal() {
    if (!shareBackdrop) return;
    shareBackdrop.classList.remove('share-modal-active');
    document.body.style.overflow = '';
  }

  function showCopiedFeedback() {
    if (shareCopiedFeedback) {
      shareCopiedFeedback.classList.add('visible');
      setTimeout(() => {
        shareCopiedFeedback.classList.remove('visible');
      }, 2000);
    }
  }

  // Open modal triggers
  shareTriggers.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openShareModal();
    });
  });

  // Close button
  if (shareCloseBtn) {
    shareCloseBtn.addEventListener('click', closeShareModal);
  }

  // Close on backdrop click (but not on content)
  if (shareBackdrop) {
    shareBackdrop.addEventListener('click', (e) => {
      if (e.target === shareBackdrop) closeShareModal();
    });
  }

  // Copy link buttons
  shareCopyBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = btn.dataset.shareUrl;
      try {
        await navigator.clipboard.writeText(url);
        showCopiedFeedback();
        // Update button text temporarily
        const label = btn.querySelector('.share-option-label');
        if (label) {
          const originalText = label.textContent;
          label.textContent = 'Copied!';
          btn.classList.add('copied');
          setTimeout(() => {
            label.textContent = originalText;
            btn.classList.remove('copied');
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback: select the input
        const input = document.getElementById('share-link-input');
        if (input) {
          input.select();
          document.execCommand('copy');
          showCopiedFeedback();
        }
      }
    });
  });

  // Native Share API (if available)
  if (shareNativeBtn) {
    if (navigator.share) {
      shareNativeBtn.style.display = 'flex';
      shareNativeBtn.addEventListener('click', async () => {
        try {
          await navigator.share({
            title: shareNativeBtn.dataset.shareTitle,
            text: shareNativeBtn.dataset.shareText,
            url: shareNativeBtn.dataset.shareUrl
          });
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
          }
        }
      });
    } else {
      // Hide if not supported
      shareNativeBtn.style.display = 'none';
    }
  }
})();
</script>
