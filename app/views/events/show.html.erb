<div class="event-page">

  <div class="event-card-detail">

    <div class="event-hero-wrapper">
      <% if @event.hero_image.attached?
%>
        <%= image_tag @event.hero_image, class: "event-hero-image" %>
      <% else %>
        <div class="event-hero-placeholder">
          <span class="placeholder-icon">ğŸ–¼ï¸</span>
        </div>
      <% end %>

      <%= link_to event_ics_path(@event), class: "calendar-download-link", target: "_blank", data: { turbo: false } do %>
        <i class="material-symbols-outlined">calendar_add_on</i>
      <% end %>
    </div>


  <div class="event-content-wrapper">

      <header class="event-header">
        <h1 class="centered-title"><%= @event.title.presence ||
 "Event" %></h1>

        <div class="event-metadata">
          <p>
            ğŸ—“ï¸ <%= @event.starts_on.strftime("%A %d %B, %H:%M") %>
            <% if @event.ends_on.present?
%>
              â€“ <%= @event.ends_on.strftime("%A %d %B, %H:%M") %>
            <% end %>
          </p>
          <p>
            ğŸ“ <%= @event.location %>
          </p>
          <p>

  ğŸ”’ <%= @event.event_private ? "Yes" : "No" %>
          </p>
        </div>
      </header>

      <section class="event-description">
        <br>
        <p><%= @event.description.presence ||
 "No description yet." %></p>
      </section>

      <%# Line 79 (Original) was split across two lines causing SyntaxError. Merged back for correct Ruby syntax: %>
      <% if user_signed_in? && @event.user == current_user %>
        <section class="event-host-tools">
          <p>
            <%= link_to "Edit event", edit_event_path(@event) %> |
 <%= link_to "Delete", @event, data: { turbo_method: :delete, turbo_confirm: "Are you sure?"
 } %>
          </p>

          <div class="host-actions-buttons">
            <button type="button" class="btn btn-action-large btn-send-blast" disabled>
              <%# START MODIFICATION: Send a blast icon changed %>
              <i class="material-symbols-outlined">campaign</i>
              <%# END MODIFICATION: Send a blast icon changed %>
              Send a blast
            </button>
            <button type="button" class="btn btn-action-large btn-invite-guests
 share-modal-trigger">
              <%# START MODIFICATION: Invite Guests icon changed %>
              <i class="material-symbols-outlined">group_add</i>
              <%# END MODIFICATION: Invite Guests icon changed %>
              Invite Guests
            </button>
          </div>
        </section>
      <% end %>

      <section class="event-rsvp">
        <h2>Attending?</h2>
        <%# Line 84 (Original) was split across two lines causing SyntaxError. Merged back for correct Ruby syntax: %>
        <% current_participation = user_signed_in? ? @event.participations.find_by(user: current_user) : nil %>
        <% current_status = current_participation&.status %>
        <%= render "shared/rsvp_segmented_control", current_status: current_status, context: "page" %>
      </section>

      <section class="event-main-layout">
        <div class="event-guests-panel">
          <%= render "guests_list", event: @event %>
        </div>

        <div class="event-activity-panel" >
          <%= render "events/activity",
 event: @event %>
        </div>
      </section>
    </div>
  </div>
</div>

<%= render "rsvp_modal" %>
<%= render "events/share_modal" %>
<%= render "events/manage_guests_modal", event: @event %>

<script>
(function() {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RSVP Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rsvpOverlay = document.querySelector('.rsvp-modal-overlay:not(.manage-guests-overlay)');
  const rsvpCloseBtn = rsvpOverlay ? rsvpOverlay.querySelector('.rsvp-modal-close') : null;
 const rsvpForm = document.getElementById('rsvp-form');
  const rsvpStatusField = document.getElementById('rsvp-status-field');
  // Page segmented control (outside modal)
  function getPageSegments() {
    return document.querySelectorAll('[data-rsvp-context="page"] .rsvp-segment');
 }

  // Modal segmented control (inside modal)
  function getModalSegments() {
    return rsvpOverlay ?
 rsvpOverlay.querySelectorAll('[data-rsvp-context="modal"] .rsvp-segment') : [];
  }

  function openRsvpModal(status) {
    if (!rsvpOverlay) return;
    rsvpOverlay.classList.remove('is-hidden');
    document.body.style.overflow = 'hidden';
 // Set the modal segmented control to match the clicked status
    const modalSegments = getModalSegments();
 modalSegments.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.rsvpStatus === status);
    });
 // Update hidden field
    if (rsvpStatusField) {
      rsvpStatusField.value = status;
 }
  }

  function closeRsvpModal() {
    if (!rsvpOverlay) return;
    rsvpOverlay.classList.add('is-hidden');
    document.body.style.overflow = '';
 }

  function setActiveSegment(status) {
    // Update page segments
    getPageSegments().forEach(seg => {
      seg.classList.toggle('active', seg.dataset.rsvpStatus === status);
    });
 }

  // Page segmented control: click opens modal
  document.addEventListener('click', (e) => {
    const pageSegment = e.target.closest('[data-rsvp-context="page"] .rsvp-segment');
    if (pageSegment) {
      const status = pageSegment.dataset.rsvpStatus;
      setActiveSegment(status);
      openRsvpModal(status);
    }
  });
 // Modal segmented control: click updates hidden field and visual state
  document.addEventListener('click', (e) => {
    const modalSegment = e.target.closest('[data-rsvp-context="modal"] .rsvp-segment');
    if (modalSegment) {
      const status = modalSegment.dataset.rsvpStatus;

      // Update modal segments visual state
      getModalSegments().forEach(btn => {
        btn.classList.toggle('active', btn.dataset.rsvpStatus === status);
      });

      // Update hidden field
      if (rsvpStatusField) {
        rsvpStatusField.value
 = status;
      }

      // Also update page segments to stay in sync
      setActiveSegment(status);
    }
  });
 if (rsvpCloseBtn) {
    rsvpCloseBtn.addEventListener('click', closeRsvpModal);
  }

  if (rsvpOverlay) {
    rsvpOverlay.addEventListener('click', (e) => {
      if (e.target === rsvpOverlay) closeRsvpModal();
    });
 }

  // Form submission handler
  if (rsvpForm) {
    rsvpForm.addEventListener('turbo:submit-end', (event) => {
      if (event.detail.success) {
        closeRsvpModal();
      }
    });
 }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Manage Guests Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const guestsOverlay = document.querySelector('.manage-guests-overlay');
 const guestsCloseBtn = guestsOverlay ? guestsOverlay.querySelector('.manage-guests-close') : null;

  function openGuestsModal() {
    if (!guestsOverlay) return;
    guestsOverlay.classList.remove('is-hidden');
 document.body.style.overflow = 'hidden';
  }

  function closeGuestsModal() {
    if (!guestsOverlay) return;
    guestsOverlay.classList.add('is-hidden');
    document.body.style.overflow = '';
 }

  // Use event delegation for manage-guests-trigger (works after Turbo updates)
  document.addEventListener('click', (e) => {
    const trigger = e.target.closest('.manage-guests-trigger');
    if (trigger) {
      e.preventDefault();
      openGuestsModal();
    }
  });
 if (guestsCloseBtn) {
    guestsCloseBtn.addEventListener('click', closeGuestsModal);
  }

  if (guestsOverlay) {
    guestsOverlay.addEventListener('click', (e) => {
      if (e.target === guestsOverlay) closeGuestsModal();
    });
 }

  // Status tab selection (visual only for now) - use event delegation
  document.addEventListener('click', (e) => {
    const tab = e.target.closest('.status-tab');
    if (tab && guestsOverlay && guestsOverlay.contains(tab)) {
      guestsOverlay.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    }
  });
 // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Share Modal
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const shareBackdrop = document.querySelector('.share-modal-backdrop');
  const shareContent = shareBackdrop ?
 shareBackdrop.querySelector('.share-modal-content') : null;
  const shareCloseBtn = shareBackdrop ? shareBackdrop.querySelector('.share-modal-close-btn') : null;
  const shareTriggers = document.querySelectorAll('.share-modal-trigger');
  const shareCopyBtns = document.querySelectorAll('.share-copy-btn, .share-link-copy-btn');
 const shareNativeBtn = document.querySelector('.share-native-btn');
  const shareCopiedFeedback = document.getElementById('share-copied-feedback');

  function openShareModal() {
    if (!shareBackdrop) return;
    shareBackdrop.classList.add('share-modal-active');
 document.body.style.overflow = 'hidden';
  }

  function closeShareModal() {
    if (!shareBackdrop) return;
    shareBackdrop.classList.remove('share-modal-active');
    document.body.style.overflow = '';
 }

  function showCopiedFeedback() {
    if (shareCopiedFeedback) {
      shareCopiedFeedback.classList.add('visible');
 setTimeout(() => {
        shareCopiedFeedback.classList.remove('visible');
      }, 2000);
 }
  }

  // Open modal triggers
  shareTriggers.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openShareModal();
    });
  });
 // Close button
  if (shareCloseBtn) {
    shareCloseBtn.addEventListener('click', closeShareModal);
  }

  // Close on backdrop click (but not on content)
  if (shareBackdrop) {
    shareBackdrop.addEventListener('click', (e) => {
      if (e.target === shareBackdrop) closeShareModal();
    });
 }

  // Copy link buttons
  shareCopyBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = btn.dataset.shareUrl;
      try {
        await navigator.clipboard.writeText(url);
        showCopiedFeedback();
        // Update button text temporarily
        const label = btn.querySelector('.share-option-label');
        if (label) {
          const originalText = label.textContent;

        label.textContent = 'Copied!';
          btn.classList.add('copied');
          setTimeout(() => {
            label.textContent = originalText;
            btn.classList.remove('copied');
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);

       // Fallback: select the input
        const input = document.getElementById('share-link-input');
        if (input) {
          input.select();
          document.execCommand('copy');
          showCopiedFeedback();
        }
      }
    });
  });
 // Native Share API (if available)
  if (shareNativeBtn) {
    if (navigator.share) {
      shareNativeBtn.style.display = 'flex';
 shareNativeBtn.addEventListener('click', async () => {
        try {
          await navigator.share({
            title: shareNativeBtn.dataset.shareTitle,
            text: shareNativeBtn.dataset.shareText,
            url: shareNativeBtn.dataset.shareUrl
          });
        } catch (err) {
          if (err.name !== 'AbortError') {

           console.error('Share failed:', err);
          }
        }
      });
 } else {
      // Hide if not supported
      shareNativeBtn.style.display = 'none';
 }
  }
})();
</script>
